[global_tags]
  location = "capes-ventura"
  environment = "homelab"

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "5s"
  flush_interval = "30s"
  flush_jitter = "5s"
  precision = ""
  hostname = "macpro"
  omit_hostname = false

# Output: expose as Prometheus metrics for Prometheus to scrape
[[outputs.prometheus_client]]
  listen = ":9273"
  metric_version = 2
  expiration_interval = "60s"

# Collect host CPU metrics
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

# Collect host memory metrics
[[inputs.mem]]

# NOTE: disk, diskio, net, system collectors require Linux /proc
# and are not available in macOS Docker. Host metrics are covered
# by Node Exporter (port 9100) which runs with host PID namespace.

# ---------------------------------------------------------------------------
# EXEC INPUTS — macOS native metric scripts mounted into container
# Scripts live in ./scripts/, mounted to /scripts/ inside container.
# Container image must be telegraf:1.29 (Debian) for bash + curl.
# Plex script uses host.docker.internal to reach Plex on the Mac host.
# ---------------------------------------------------------------------------

# Disk usage — host-side metrics file written by LaunchAgent every 30s
# (Docker cannot see individual macOS APFS volumes via df; host writes the file)
[[inputs.file]]
  files = ["/host-metrics/disk_metrics.prom", "/host-metrics/smart_metrics.prom"]
  data_format = "prometheus"

# SMART drive health and temperature
[[inputs.exec]]
  commands = ["/scripts/smart_metrics.sh"]
  timeout = "30s"
  interval = "5m"
  data_format = "prometheus"

# SMB share session counts and auth failures
[[inputs.exec]]
  commands = ["/scripts/smb_metrics.sh"]
  timeout = "15s"
  interval = "60s"
  data_format = "prometheus"

# Security events: SSH, console login, sudo, screen lock, auth failures
[[inputs.exec]]
  commands = ["/scripts/security_metrics.sh"]
  timeout = "20s"
  interval = "60s"
  data_format = "prometheus"

# Plex active streams
[[inputs.exec]]
  commands = ["/scripts/plex_metrics.sh"]
  timeout = "10s"
  interval = "30s"
  data_format = "prometheus"
  environment = ["PLEX_TOKEN=XDMas6E2Nq7-MCGkeeDE"]

# ---------------------------------------------------------------------------
# Orbi RBR750 — router/mesh metrics via SOAP API (replaces SNMP v1.2.0)
# SNMP is NOT available on Netgear Orbi RBR750 firmware.
# orbi_metrics.sh v2.0.0 uses the undocumented SOAP endpoint:
#   https://192.168.1.1/soap/server_sa/
#   Auth: HTTP Basic (stateless per-request — no session required)
#   Credentials: ROUTER_PASS env var (sourced from .env) or macOS Keychain
#
# Metrics produced:
#   orbi_up                     — router reachability (ping)
#   orbi_firmware_info          — firmware version label
#   orbi_wan_up                 — WAN/internet connection + public IP
#   orbi_cpu_utilization_pct    — router CPU %
#   orbi_memory_utilization_pct — router RAM %
#   orbi_radio_up               — WiFi radio status
#   orbi_radio_info             — SSID, channel, security mode
#   orbi_devices_total          — total connected devices
#   orbi_devices_by_connection  — wired / 2.4GHz / 5GHz counts
#   orbi_node_device_count      — devices per Orbi mesh node (router vs satellite)
#   orbi_device_rssi            — per-device signal strength with name/IP/band/node
#   orbi_device_linkspeed_mbps  — per-device negotiated link speed
#   orbi_satellite_up           — satellite node ping reachability
#   orbi_ping_rtt_ms            — RTT to router, Cloudflare, Google
#   orbi_dns_resolve_ms         — DNS resolution latency
# ---------------------------------------------------------------------------
[[inputs.exec]]
  commands = ["/Volumes/4tb-R1/Docker Services/NetworkObservability/scripts/orbi_metrics.sh"]
  timeout = "60s"
  interval = "30s"
  data_format = "prometheus"
  environment = [
    "ROUTER_PASS=Psw500rr!!"
  ]
