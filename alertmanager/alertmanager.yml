# =============================================================================
# Alertmanager config â€” Capes Homelab NetworkObservability
# Credentials sourced from ../.env (gitignored)
# Host: Mac Pro 192.168.1.30 | macOS 12.7.6
# =============================================================================

global:
  resolve_timeout: 5m
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'am180vta@gmail.com'
  smtp_auth_username: 'am180vta@gmail.com'
  smtp_auth_password: 'cvsb wnei uifb wrjc'
  smtp_require_tls: true

route:
  group_by: ['alertname', 'host', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'default-email'
  routes:
    - matchers:
        - severity="critical"
      receiver: 'critical-alerts'
      repeat_interval: 1h
    - matchers:
        - severity="warning"
      receiver: 'default-email'
      repeat_interval: 4h

receivers:
  - name: 'default-email'
    email_configs:
      - to: 'matt@am180.us'
        send_resolved: true
        headers:
          Subject: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} â€” Capes Network (192.168.1.30)'
        html: |
          <div style="font-family:Arial,sans-serif;max-width:600px">
          <h2 style="color:{{ if eq .Status "firing" }}#d63031{{ else }}#00b894{{ end }}">
            {{ .Status | toUpper }}: {{ .GroupLabels.alertname }}
          </h2>
          <p><b>Host:</b> Mac Pro â€” mMacPro.local (192.168.1.30)<br>
          <b>Time:</b> {{ (index .Alerts 0).StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
          <hr>
          {{ range .Alerts }}
          <p><b>Summary:</b> {{ .Annotations.summary }}<br>
          <b>Detail:</b> {{ .Annotations.description }}<br>
          <b>Labels:</b> {{ range .Labels.SortedPairs }}<code>{{ .Name }}={{ .Value }}</code> {{ end }}</p>
          {{ end }}
          <hr>
          <p style="font-size:11px;color:#636e72">
            NetworkObservability Stack Â· The Capes, Ventura CA Â·
            <a href="http://192.168.1.30:3000">Open Grafana</a>
          </p>
          </div>

  - name: 'critical-alerts'
    email_configs:
      - to: 'matt@am180.us'
        send_resolved: true
        headers:
          Subject: 'ðŸš¨ [CRITICAL] {{ .GroupLabels.alertname }} â€” Capes Network'
        html: |
          <div style="font-family:Arial,sans-serif;max-width:600px;border-left:4px solid #d63031;padding-left:16px">
          <h2 style="color:#d63031">ðŸš¨ CRITICAL: {{ .GroupLabels.alertname }}</h2>
          <p><b>Host:</b> Mac Pro â€” mMacPro.local (192.168.1.30)</p>
          {{ range .Alerts }}
          <p><b>Summary:</b> {{ .Annotations.summary }}<br>
          <b>Detail:</b> {{ .Annotations.description }}</p>
          {{ end }}
          <p><a href="http://192.168.1.30:3000">â†’ Open Grafana Dashboard</a></p>
          </div>

# Silence critical if already triggered a warning for same alert+instance
inhibit_rules:
  - source_matchers:
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal: ['alertname', 'instance']
