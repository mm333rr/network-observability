# =============================================================================
# NetworkObservability Stack — Prometheus + Grafana + Loki + Telegraf
# Bound to: 192.168.1.5 (loopback alias on Mac Pro, secondary IP on Pi eth0)
#
# ARCHITECTURE:
#   192.168.1.2  — AdGuard DNS/DHCP  (separate stack: AdGuardHome/)
#   192.168.1.5  — This stack        (all service ports bind here)
#
# On Mac Pro:   both IPs are loopback aliases on lo0
# On Pi:        both IPs are secondary addresses on eth0 (ip addr add)
#
# Service URLs (from LAN):
#   Grafana:      http://192.168.1.5:3000
#   Prometheus:   http://192.168.1.5:9090
#   Alertmanager: http://192.168.1.5:9093
#   Loki:         http://192.168.1.5:3100
#   Promtail UI:  http://192.168.1.5:9080
#   Node Exporter:http://192.168.1.5:9100
#   Telegraf:     http://192.168.1.5:9273
#   cAdvisor:     http://192.168.1.5:8080
# =============================================================================

networks:
  observability:
    name: networkobservability_observability
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

# DNS anchor — all containers resolve .capes.local and .am180.us via AdGuard
x-dns: &dns
  dns:
    - 192.168.1.2
    - 1.1.1.1

services:

  # ---------------------------------------------------------------------------
  # GRAFANA — Dashboard UI
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.3.3
    container_name: grafana
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:3000:3000"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASS:-changeme}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://192.168.1.5:3000
      - GF_SERVER_DOMAIN=192.168.1.5
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/home.json
    depends_on:
      - prometheus
      - loki
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # PROMETHEUS — Metrics scraping & storage
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: prometheus
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:9090:9090"
    volumes:
      - ./data/prometheus:/prometheus
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-90d}"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # ALERTMANAGER — Alert routing and email delivery
  # ---------------------------------------------------------------------------
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: alertmanager
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:9093:9093"
    volumes:
      - ./data/alertmanager:/alertmanager
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ./alertmanager/entrypoint.sh:/entrypoint.sh:ro
    env_file:
      - ${SMTP_SECRETS_FILE}
    entrypoint: ["/bin/sh", "/entrypoint.sh"]
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # NODE EXPORTER — Host system metrics
  # ---------------------------------------------------------------------------
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: node-exporter
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:9100:9100"
    pid: host
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
      - /Volumes:/rootfs/Volumes:ro
    command:
      - "--path.procfs=/host/proc"
      - "--path.rootfs=/rootfs"
      - "--path.sysfs=/host/sys"
      - "--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)"
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # LOKI — Log aggregation backend
  # ---------------------------------------------------------------------------
  loki:
    image: grafana/loki:2.9.4
    container_name: loki
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:3100:3100"
    volumes:
      - ./data/loki:/loki
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # PROMTAIL — Log shipper + syslog receiver
  # ---------------------------------------------------------------------------
  promtail:
    image: grafana/promtail:2.9.4
    container_name: promtail
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:9080:9080"
      - "192.168.1.5:1514:1514/udp"
    volumes:
      - /var/log:/var/log:ro
      - /Users/mProAdmin/Library/Logs/Plex Media Server:/plex-logs:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # TELEGRAF — Exec metrics: Plex, Orbi, SMART, SMB, security
  # ---------------------------------------------------------------------------
  telegraf:
    image: telegraf:1.29-alpine
    container_name: telegraf
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:9273:9273"
    volumes:
      - ./telegraf/telegraf.conf:/etc/telegraf/telegraf.conf:ro
      - ./scripts:/scripts:ro
      - /Volumes:/Volumes:ro
      - ./host-metrics:/host-metrics:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - HOST_HOSTNAME=${HOST_HOSTNAME:-macpro}
      - PLEX_TOKEN=${PLEX_TOKEN}
      - PLEX_HOST=${PLEX_HOST:-192.168.1.30}
      - PLEX_PORT=${PLEX_PORT:-32400}
      - ROUTER_IP=${ROUTER_IP:-192.168.1.1}
      - ROUTER_PASS=${ROUTER_PASS}
    labels:
      - stack=observability

  # ---------------------------------------------------------------------------
  # cADVISOR — Docker container metrics
  # ---------------------------------------------------------------------------
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: cadvisor
    restart: unless-stopped
    <<: *dns
    networks:
      - observability
    ports:
      - "192.168.1.5:8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
    privileged: true
    labels:
      - stack=observability
